<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Orphanage Dashboard | FoodBridge</title>
    
    <!-- Browser Tab Icon (Using SVG equivalent of the FontAwesome icon) -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 576 512'%3E%3Cpath fill='%2310B981' d='M163.9 136.9c-29.4-29.8-29.4-78.2 0-108s77-29.8 106.4 0l17.7 18 17.7-18c29.4-29.8 77-29.8 106.4 0s29.4 78.2 0 108L310.5 240.1c-6.2 6.3-14.3 9.4-22.5 9.4s-16.3-3.1-22.5-9.4L163.9 136.9zm341.6-47.8c-11.4-18-31.5-28.2-52.6-26.6 9.4 16.5 14.2 35.4 13.6 54.8-1.1 41.5-35.3 75.2-76.9 75.3-25.7 0-48.4-13-61.9-33.1L288 200.5l-39.7-41c-13.5 20.1-36.2 33.1-61.9 33.1-41.5-.1-75.7-33.8-76.9-75.3-.6-19.4 4.1-38.3 13.6-54.8-21.1-1.6-41.2 8.6-52.6 26.6-13.7 21.6-14 49.3-1.6 71.5l143.6 257c6.1 10.9 17.6 17.7 30 17.7 12.5 0 24-6.8 30-17.7l143.6-257c12.4-22.2 12.1-49.9-1.6-71.5zM565.4 97c-9.2-24.8-28.7-44.5-53.5-53.7-27.4-10.2-56.5-1.5-76.6 20.6 6.1 7.2 11.2 15.2 15 24 16-7.3 34.6-6.4 49.8 2.3 8.1 4.7 14.8 11.4 19.5 19.5 14.3 24.8 8.1 55.4-13.4 73.5l-42.6 35.9c7.8 7.3 16.3 13.8 25.5 19.2l39-32.9c32.9-27.8 45-73.4 37.3-108.4zM49.2 63.9C24.4 73.1 4.9 92.8-4.3 117.6c-7.7 35 4.3 80.6 37.3 108.4l39 32.9c9.2-5.4 17.7-11.9 25.5-19.2L55.1 203.8c-21.5-18.1-27.7-48.7-13.4-73.5 4.7-8.1 11.4-14.8 19.5-19.5 15.2-8.7 33.8-9.6 49.8-2.3 3.8-8.8 8.9-16.8 15-24-20.2-22.1-49.3-30.8-76.8-20.6z'/%3E%3C/svg%3E">

    <!-- Tailwind & FontAwesome -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Poppins', 'sans-serif'] },
                    colors: {
                        brand: {
                            green: '#10B981',
                            dark: '#1F2937',
                            light: '#ECFDF5',
                            orange: '#F97316'
                        }
                    },
                    animation: { 'fade-in': 'fadeIn 0.5s ease-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>
    <style>
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        body { background-image: url('https://images.unsplash.com/photo-1488521787991-ed7bbaae773c?q=80&w=2000&auto=format&fit=crop'); background-size: cover; background-position: center; background-attachment: fixed; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: -1; }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col md:flex-row overflow-hidden">
    <div class="overlay"></div>

    <!-- MOBILE OVERLAY FOR SIDEBAR -->
    <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-20 hidden md:hidden glass-panel"></div>

    <!-- SIDEBAR -->
    <aside id="sidebar" class="fixed md:relative w-72 bg-white h-full flex flex-col z-30 transform -translate-x-full md:translate-x-0 transition-transform duration-300 shadow-2xl">
        <div class="p-8 border-b border-gray-100 flex items-center gap-3">
            <i class="fa-solid fa-hand-holding-heart text-3xl text-brand-green"></i>
            <div>
                <h1 class="text-xl font-bold text-gray-800 tracking-tight">Food<span class="text-brand-green">Bridge</span></h1>
                <p class="text-[10px] text-gray-500 uppercase tracking-widest font-semibold">Orphanage Portal</p>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto p-4 space-y-2">
            <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center gap-4 px-6 py-4 text-sm font-semibold text-white bg-brand-green rounded-xl shadow-lg shadow-brand-green/30 transition-all">
                <i class="fa-solid fa-chart-pie text-lg"></i> Dashboard
            </button>
            <button onclick="switchTab('requests')" id="nav-requests" class="nav-item w-full flex items-center gap-4 px-6 py-4 text-sm font-semibold text-gray-500 hover:bg-gray-50 rounded-xl transition-all">
                <i class="fa-solid fa-hands-praying text-lg"></i> Urgent Needs
            </button>
            <button onclick="switchTab('history')" id="nav-history" class="nav-item w-full flex items-center gap-4 px-6 py-4 text-sm font-semibold text-gray-500 hover:bg-gray-50 rounded-xl transition-all">
                <i class="fa-solid fa-clock-rotate-left text-lg"></i> History
            </button>
        </nav>

        <div class="p-6 border-t border-gray-100">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 rounded-full bg-brand-green/10 text-brand-green flex items-center justify-center font-bold">O</div>
                <div class="overflow-hidden">
                    <p class="text-sm font-bold truncate" id="user-name">Loading...</p>
                    <p class="text-xs text-gray-400 truncate" id="user-email">...</p>
                </div>
            </div>
            <button onclick="logout()" class="w-full py-2.5 text-xs font-bold text-red-500 bg-red-50 hover:bg-red-100 rounded-lg transition-colors flex items-center justify-center gap-2">
                <i class="fa-solid fa-right-from-bracket"></i> Sign Out
            </button>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col h-full relative overflow-hidden">
        
        <!-- Mobile Header -->
        <header class="md:hidden h-16 bg-white/90 backdrop-blur-md shadow-sm flex items-center justify-between px-4 z-20">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-hand-holding-heart text-brand-green text-xl"></i>
                <span class="font-bold text-gray-800">Orphanage</span>
            </div>
            <button onclick="toggleSidebar()" class="p-2 text-gray-600"><i class="fa-solid fa-bars text-xl"></i></button>
        </header>

        <!-- Content Body -->
        <div class="flex-1 overflow-y-auto p-4 md:p-8" id="main-scroll">
            
            <!-- DASHBOARD TAB -->
            <div id="view-dashboard" class="max-w-6xl mx-auto space-y-8 animate-fade-in">
                
                <!-- Welcome & Stats -->
                <div>
                    <h2 class="text-2xl font-bold text-white drop-shadow-md mb-6">Overview</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Stat 1 -->
                        <div class="bg-white/90 backdrop-blur rounded-2xl p-6 shadow-lg border-b-4 border-brand-green">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-xs text-gray-500 font-bold uppercase tracking-wider">Total Received</p>
                                    <h3 class="text-3xl font-extrabold text-gray-800 mt-1" id="stat-received">0</h3>
                                    <p class="text-xs text-green-600 mt-1 font-medium">Meals secured</p>
                                </div>
                                <div class="bg-brand-green/10 p-3 rounded-xl text-brand-green">
                                    <i class="fa-solid fa-utensils text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <!-- Stat 2 -->
                        <div class="bg-white/90 backdrop-blur rounded-2xl p-6 shadow-lg border-b-4 border-blue-500">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-xs text-gray-500 font-bold uppercase tracking-wider">Incoming</p>
                                    <h3 class="text-3xl font-extrabold text-gray-800 mt-1" id="stat-incoming">0</h3>
                                    <p class="text-xs text-blue-600 mt-1 font-medium">Orders on the way</p>
                                </div>
                                <div class="bg-blue-50 p-3 rounded-xl text-blue-500">
                                    <i class="fa-solid fa-truck-fast text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <!-- Stat 3 -->
                        <div class="bg-white/90 backdrop-blur rounded-2xl p-6 shadow-lg border-b-4 border-brand-orange">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-xs text-gray-500 font-bold uppercase tracking-wider">Active Requests</p>
                                    <h3 class="text-3xl font-extrabold text-gray-800 mt-1" id="stat-requests">0</h3>
                                    <p class="text-xs text-orange-600 mt-1 font-medium">Urgent needs posted</p>
                                </div>
                                <div class="bg-orange-50 p-3 rounded-xl text-brand-orange">
                                    <i class="fa-solid fa-bullhorn text-xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section: Incoming Deliveries (Live Orders) -->
                <div id="section-incoming" class="hidden">
                    <h3 class="text-xl font-bold text-white drop-shadow-md mb-4 flex items-center">
                        <i class="fa-solid fa-truck-clock mr-2"></i> Incoming Deliveries
                    </h3>
                    <div id="incoming-container" class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Section: Available Donations Feed -->
                <div>
                    <div class="flex justify-between items-end mb-4">
                        <h3 class="text-xl font-bold text-white drop-shadow-md flex items-center">
                            <i class="fa-solid fa-store mr-2"></i> Available Food
                        </h3>
                        <span class="bg-white/20 backdrop-blur text-white text-xs px-2 py-1 rounded">Live Feed from Restaurants</span>
                    </div>
                    
                    <div id="donations-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Loader -->
                        <div class="col-span-full py-12 text-center text-white/80">
                            <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                            <p>Searching for nearby donations...</p>
                        </div>
                    </div>
                </div>

            </div>

            <!-- REQUESTS TAB (Urgent Need) -->
            <div id="view-requests" class="max-w-4xl mx-auto space-y-6 animate-fade-in hidden">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-white drop-shadow-md">Urgent Needs</h2>
                    <button onclick="openRequestModal()" class="bg-brand-orange hover:bg-orange-600 text-white px-6 py-2.5 rounded-xl font-bold shadow-lg transition transform hover:scale-105 flex items-center gap-2">
                        <i class="fa-solid fa-plus"></i> Post New Request
                    </button>
                </div>

                <!-- My Requests List -->
                <div class="bg-white/95 backdrop-blur rounded-3xl shadow-xl overflow-hidden min-h-[400px]">
                    <div id="my-requests-container" class="divide-y divide-gray-100">
                        <!-- JS populated -->
                        <div class="p-10 text-center text-gray-400">
                            <i class="fa-regular fa-folder-open text-4xl mb-3"></i>
                            <p>You haven't posted any urgent needs yet.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- HISTORY TAB -->
            <div id="view-history" class="max-w-5xl mx-auto space-y-6 animate-fade-in hidden">
                <h2 class="text-2xl font-bold text-white drop-shadow-md">Activity History</h2>
                <div class="bg-white/95 backdrop-blur rounded-3xl shadow-xl overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-50 text-gray-500 font-bold uppercase text-xs border-b border-gray-100">
                                <tr>
                                    <th class="px-6 py-4">Date</th>
                                    <th class="px-6 py-4">Activity</th>
                                    <th class="px-6 py-4">Details</th>
                                    <th class="px-6 py-4">From/To</th>
                                    <th class="px-6 py-4">Status</th>
                                </tr>
                            </thead>
                            <tbody id="history-tbody" class="divide-y divide-gray-100">
                                <!-- JS Populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- REQUEST MODAL -->
    <div id="request-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fade-in">
        <div class="bg-white rounded-2xl w-full max-w-md shadow-2xl overflow-hidden transform transition-all scale-100">
            <div class="bg-brand-orange p-6 text-white flex justify-between items-center">
                <h3 class="text-lg font-bold"><i class="fa-solid fa-bullhorn mr-2"></i> Post Urgent Need</h3>
                <button onclick="closeRequestModal()" class="text-white/80 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <form onsubmit="submitUrgentRequest(event)" class="p-6 space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">What do you need?</label>
                    <input type="text" id="req-item" required placeholder="e.g. Rice Meals, Milk, Bread" class="w-full p-3 bg-gray-50 rounded-lg border border-gray-200 focus:border-brand-orange focus:outline-none transition">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Quantity</label>
                    <input type="number" id="req-qty" required placeholder="e.g. 50" class="w-full p-3 bg-gray-50 rounded-lg border border-gray-200 focus:border-brand-orange focus:outline-none transition">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Additional Note</label>
                    <textarea id="req-note" rows="3" placeholder="Any specific dietary requirements..." class="w-full p-3 bg-gray-50 rounded-lg border border-gray-200 focus:border-brand-orange focus:outline-none transition"></textarea>
                </div>
                <button type="submit" class="w-full py-3 bg-brand-orange text-white rounded-xl font-bold hover:bg-orange-600 shadow-lg transition transform hover:-translate-y-0.5">Post Request</button>
            </form>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed bottom-6 right-6 left-6 md:left-auto bg-brand-dark text-white px-6 py-4 rounded-xl shadow-2xl transform translate-y-32 opacity-0 transition-all duration-500 flex items-center gap-4 z-[60]">
        <i class="fa-solid fa-circle-check text-brand-green text-lg"></i>
        <p class="text-sm" id="toast-message">Success</p>
    </div>

    <script>
        // --- Firebase Config ---
        const firebaseConfig = { apiKey: "AIzaSyDB-qF6Ac93Tj3LR3DI6aTuUtkFNRMDai0", authDomain: "panel-9e1a6.firebaseapp.com", projectId: "panel-9e1a6", storageBucket: "panel-9e1a6.firebasestorage.app", messagingSenderId: "491001640513", appId: "1:491001640513:web:ddbf48cf060ae10d0e38c0" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(); const db = firebase.firestore();
        let currentUser = null;

        // --- Auth & Init ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                loadUserProfile();
                initRealtimeListeners();
            } else {
                window.location.href = 'https://foodbridge.qzz.io/login.html';
            }
        });

        // --- UI Functions ---
        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            if(sb.classList.contains('-translate-x-full')) {
                sb.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sb.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        function switchTab(tab) {
            ['dashboard', 'requests', 'history'].forEach(t => {
                document.getElementById('view-'+t).classList.add('hidden');
                const btn = document.getElementById('nav-'+t);
                btn.className = "nav-item w-full flex items-center gap-4 px-6 py-4 text-sm font-semibold text-gray-500 hover:bg-gray-50 rounded-xl transition-all";
            });
            document.getElementById('view-'+tab).classList.remove('hidden');
            const activeBtn = document.getElementById('nav-'+tab);
            activeBtn.className = "nav-item w-full flex items-center gap-4 px-6 py-4 text-sm font-semibold text-white bg-brand-green rounded-xl shadow-lg shadow-brand-green/30 transition-all";
            
            if(window.innerWidth < 768) toggleSidebar();
        }

        // --- Logic ---
        function loadUserProfile() {
            document.getElementById('user-email').innerText = currentUser.email;
            db.collection('users').doc(currentUser.uid).get().then(doc => {
                if(doc.exists) document.getElementById('user-name').innerText = doc.data().name;
            });
        }

        function initRealtimeListeners() {
            // 1. STATS: Donations Completed
            db.collection('donations').where('orphanageId', '==', currentUser.uid).where('status', '==', 'Completed')
                .onSnapshot(snap => {
                    let total = 0;
                    snap.forEach(d => total += parseInt(d.data().servings || 0));
                    document.getElementById('stat-received').innerText = total;
                });

            // 2. STATS & REQUESTS: My Urgent Requests
            db.collection('requests').where('orphanageId', '==', currentUser.uid)
                .onSnapshot(snap => {
                    document.getElementById('stat-requests').innerText = snap.size; // Only counts active ones if we filtered by status
                    renderMyRequests(snap);
                });

            // 3. STATS & LIVE ORDERS: Incoming Deliveries
            db.collection('donations').where('orphanageId', '==', currentUser.uid).where('status', '==', 'Claimed')
                .onSnapshot(snap => {
                    document.getElementById('stat-incoming').innerText = snap.size;
                    renderIncoming(snap);
                });

            // 4. FEED: Available Donations
            db.collection('donations').where('status', '==', 'Available')
                .onSnapshot(snap => renderAvailableDonations(snap));

            // 5. HISTORY: Combined (Simple approach: just donations for now, could merge requests)
            db.collection('donations').where('orphanageId', '==', currentUser.uid)
                .orderBy('updatedAt', 'desc').limit(20)
                .onSnapshot(snap => renderHistory(snap));
        }

        // --- Render Functions ---
        function renderAvailableDonations(snap) {
            const container = document.getElementById('donations-container');
            container.innerHTML = '';
            if(snap.empty) {
                container.innerHTML = `<div class="col-span-full py-12 text-center text-white/80"><i class="fa-solid fa-utensils text-4xl mb-2 opacity-50"></i><p>No donations available right now.</p></div>`;
                return;
            }
            snap.forEach(doc => {
                const d = doc.data();
                container.innerHTML += `
                    <div class="bg-white rounded-2xl p-6 shadow-lg border border-gray-100 hover:scale-[1.02] transition-transform duration-300">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="font-bold text-lg text-gray-800 leading-tight">${d.foodName}</h3>
                                <p class="text-xs text-gray-500 font-medium mt-1"><i class="fa-solid fa-store mr-1"></i> ${d.restaurantName}</p>
                            </div>
                            <span class="bg-green-100 text-brand-green text-[10px] font-bold px-2 py-1 rounded-full uppercase">${d.foodType}</span>
                        </div>
                        <div class="flex items-center gap-4 text-sm text-gray-600 mb-4 bg-gray-50 p-3 rounded-xl">
                            <span class="font-bold"><i class="fa-solid fa-users text-brand-green mr-1"></i> ${d.servings} Servings</span>
                            <span><i class="fa-solid fa-clock text-orange-400 mr-1"></i> ${d.expiryTime || '2h'} Left</span>
                        </div>
                        <button onclick="claimDonation('${doc.id}')" class="w-full py-3 bg-brand-dark hover:bg-black text-white rounded-xl font-bold shadow-md transition-colors">
                            Claim Food
                        </button>
                    </div>
                `;
            });
        }

        function renderIncoming(snap) {
            const section = document.getElementById('section-incoming');
            const container = document.getElementById('incoming-container');
            container.innerHTML = '';
            
            if(snap.empty) {
                section.classList.add('hidden');
                return;
            }
            section.classList.remove('hidden');

            snap.forEach(doc => {
                const d = doc.data();
                container.innerHTML += `
                    <div class="bg-blue-50/90 backdrop-blur rounded-2xl p-5 border border-blue-100 flex flex-col md:flex-row justify-between items-center gap-4 shadow-sm">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xl">
                                <i class="fa-solid fa-truck"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-800">${d.foodName}</h4>
                                <p class="text-xs text-gray-500">From: ${d.restaurantName}</p>
                                <p class="text-xs font-bold text-blue-600 mt-1">Status: On the way</p>
                            </div>
                        </div>
                        <button onclick="markReceived('${doc.id}')" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold text-sm shadow transition">
                            Received
                        </button>
                    </div>
                `;
            });
        }

        function renderMyRequests(snap) {
            const container = document.getElementById('my-requests-container');
            container.innerHTML = '';
            if(snap.empty) {
                container.innerHTML = `<div class="p-10 text-center text-gray-400"><i class="fa-regular fa-folder-open text-4xl mb-3"></i><p>No active requests.</p></div>`;
                return;
            }
            snap.forEach(doc => {
                const d = doc.data();
                const statusColor = d.status === 'Fulfilled' ? 'text-green-600 bg-green-50' : 'text-orange-600 bg-orange-50';
                container.innerHTML += `
                    <div class="p-5 flex justify-between items-center hover:bg-gray-50 transition">
                        <div>
                            <h4 class="font-bold text-gray-800 text-lg">${d.itemNeeded}</h4>
                            <p class="text-sm text-gray-500">Qty: ${d.quantity}</p>
                            <p class="text-xs text-gray-400 mt-1"><i class="fa-regular fa-clock mr-1"></i> Posted: ${d.createdAt ? new Date(d.createdAt.seconds*1000).toLocaleDateString() : 'Just now'}</p>
                        </div>
                        <span class="px-3 py-1 rounded-full text-xs font-bold uppercase ${statusColor}">${d.status}</span>
                    </div>
                `;
            });
        }

        function renderHistory(snap) {
            const tbody = document.getElementById('history-tbody');
            tbody.innerHTML = '';
            snap.forEach(doc => {
                const d = doc.data();
                // Filter out 'Claimed' because those are 'Live' orders
                if(d.status !== 'Claimed') {
                    let statusClass = 'bg-gray-100 text-gray-600';
                    if(d.status === 'Completed') statusClass = 'bg-green-100 text-green-700';
                    if(d.status === 'Issue') statusClass = 'bg-red-100 text-red-700';

                    tbody.innerHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 text-gray-500">${d.updatedAt ? new Date(d.updatedAt.seconds*1000).toLocaleDateString() : '-'}</td>
                            <td class="px-6 py-4 font-bold text-gray-700">Donation Received</td>
                            <td class="px-6 py-4 text-gray-600">${d.foodName} (${d.servings} servings)</td>
                            <td class="px-6 py-4 text-gray-500">From: ${d.restaurantName}</td>
                            <td class="px-6 py-4"><span class="px-3 py-1 rounded-full text-xs font-bold uppercase ${statusClass}">${d.status}</span></td>
                        </tr>
                    `;
                }
            });
        }

        // --- Interaction Logic ---

        async function claimDonation(id) {
            if(!confirm("Are you sure you want to claim this donation?")) return;
            try {
                // Get fresh user name
                const uDoc = await db.collection('users').doc(currentUser.uid).get();
                const uName = uDoc.data().name;

                await db.collection('donations').doc(id).update({
                    status: 'Claimed',
                    orphanageId: currentUser.uid,
                    orphanageName: uName,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showToast("Claimed! View in dashboard.");
            } catch(e) { console.error(e); showToast("Error claiming.", true); }
        }

        async function markReceived(id) {
            try {
                await db.collection('donations').doc(id).update({
                    status: 'Completed',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showToast("Order Completed!");
            } catch(e) { showToast("Error updating.", true); }
        }

        // Urgent Requests
        function openRequestModal() { document.getElementById('request-modal').classList.remove('hidden'); }
        function closeRequestModal() { document.getElementById('request-modal').classList.add('hidden'); }

        async function submitUrgentRequest(e) {
            e.preventDefault();
            const item = document.getElementById('req-item').value;
            const qty = document.getElementById('req-qty').value;
            const note = document.getElementById('req-note').value;

            try {
                const uDoc = await db.collection('users').doc(currentUser.uid).get();
                
                await db.collection('requests').add({
                    orphanageId: currentUser.uid,
                    orphanageName: uDoc.data().name,
                    itemNeeded: item,
                    quantity: qty,
                    note: note,
                    status: 'Pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showToast("Request Posted!");
                closeRequestModal();
                e.target.reset();
            } catch(error) { showToast("Failed to post.", true); }
        }

        function logout() {
            auth.signOut().then(() => window.location.href = 'https://foodbridge.qzz.io/index.html');
        }

        function showToast(msg, isError = false) {
            const t = document.getElementById('toast');
            const icon = t.querySelector('i');
            icon.className = isError ? 'fa-solid fa-circle-exclamation text-red-500 text-lg' : 'fa-solid fa-circle-check text-brand-green text-lg';
            document.getElementById('toast-message').innerText = msg;
            t.classList.remove('translate-y-32', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-32', 'opacity-0'), 3000);
        }
    </script>
</body>
</html>
